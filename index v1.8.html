<!-- Version 1.8 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Markdown Editor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --header-bg: #222;
      --preview-bg: #1e1e1e;
      --accent-color: #70cfff;
      --button-bg: #333;
      --button-hover: #555;
      --divider-color: #444;
      --divider-handle: #666;
      --toolbar-bg: #2a2a2a;
      --editor-bg: #1a1a1a;
    }

    /* Dark Theme (Default) */
    .theme-dark {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --header-bg: #222;
      --preview-bg: #1e1e1e;
      --accent-color: #70cfff;
      --button-bg: #333;
      --button-hover: #555;
      --divider-color: #444;
      --toolbar-bg: #2a2a2a;
      --editor-bg: #1a1a1a;
    }

    /* Light Theme */
    .theme-light {
      --bg-color: #ffffff;
      --text-color: #333333;
      --header-bg: #f5f5f5;
      --preview-bg: #f9f9f9;
      --accent-color: #0066cc;
      --button-bg: #e0e0e0;
      --button-hover: #d0d0d0;
      --divider-color: #ddd;
      --toolbar-bg: #f0f0f0;
      --editor-bg: #ffffff;
    }

    /* Blue Theme */
    .theme-blue {
      --bg-color: #0d1b2a;
      --text-color: #e0e1dd;
      --header-bg: #1b263b;
      --preview-bg: #0f1c2e;
      --accent-color: #48cae4;
      --button-bg: #415a77;
      --button-hover: #5e7ba1;
      --divider-color: #314a6e;
      --toolbar-bg: #1b263b;
      --editor-bg: #0d1b2a;
    }

    /* Dark Blue Theme */
    .theme-dark-blue {
      --bg-color: #0a192f;
      --text-color: #ccd6f6;
      --header-bg: #112240;
      --preview-bg: #0f1a2e;
      --accent-color: #64ffda;
      --button-bg: #233554;
      --button-hover: #3a597d;
      --divider-color: #1e3a6b;
      --toolbar-bg: #112240;
      --editor-bg: #0a192f;
    }

    /* Deep Purple Theme */
    .theme-deep-purple {
      --bg-color: #1a1a2e;
      --text-color: #e2e2e2;
      --header-bg: #16213e;
      --preview-bg: #1a1a3a;
      --accent-color: #a6b1e1;
      --button-bg: #3d2c5a;
      --button-hover: #5a3d7a;
      --divider-color: #3a2c5a;
      --toolbar-bg: #16213e;
      --editor-bg: #1a1a2e;
    }

    /* Solarized Dark Theme */
    .theme-solarized {
      --bg-color: #002b36;
      --text-color: #839496;
      --header-bg: #073642;
      --preview-bg: #01313f;
      --accent-color: #2aa198;
      --button-bg: #586e75;
      --button-hover: #657b83;
      --divider-color: #475b62;
      --toolbar-bg: #073642;
      --editor-bg: #002b36;
    }

    * { box-sizing: border-box; }
    
    /* Fixed scrolling: prevent body scroll */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* Prevent window scrolling */
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
    }
    
    body {
      display: flex;
      flex-direction: column;
    }
    
    header {
      padding: 12px 20px;
      background: var(--header-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--divider-color);
      flex-shrink: 0; /* Prevent header from shrinking */
    }
    header h1 {
      margin: 0;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .toolbar button, .toolbar select {
      padding: 6px 12px;
      background: var(--button-bg);
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s ease;
    }
    .toolbar button:hover, .toolbar select:hover {
      background: var(--button-hover);
    }
    .toolbar select {
      padding: 6px 3px;
    }

    /* Rich Toolbar Styles */
    .rich-toolbar {
      padding: 8px 15px;
      background: var(--toolbar-bg);
      border-bottom: 1px solid var(--divider-color);
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
      flex-shrink: 0; /* Prevent toolbar from shrinking */
    }
    .toolbar-group {
      display: flex;
      gap: 2px;
      padding-right: 10px;
      border-right: 1px solid var(--divider-color);
      margin-right: 5px;
    }
    .toolbar-group:last-child {
      border-right: none;
      margin-right: 0;
    }
    .toolbar-btn {
      padding: 6px 8px;
      background: transparent;
      color: var(--text-color);
      border: 1px solid transparent;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s ease;
      min-width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .toolbar-btn:hover {
      background: var(--button-hover);
      border-color: var(--divider-color);
    }
    .toolbar-btn.active {
      background: var(--accent-color);
      color: var(--bg-color);
    }
    .toolbar-select {
      padding: 4px 8px;
      background: var(--button-bg);
      color: var(--text-color);
      border: 1px solid var(--divider-color);
      border-radius: 3px;
      font-size: 0.85em;
      cursor: pointer;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden; /* Prevent main from scrolling */
      min-height: 0; /* Allow flex children to shrink */
    }

    /* Fixed layout for live preview mode */
    .main-live {
      flex-direction: row;
    }

    .main-manual {
      flex-direction: column;
    }

    .editor-container, .preview-container {
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Prevent container scrolling */
      min-height: 0; /* Allow flex children to shrink */
    }

    /* Live preview mode - side by side */
    .main-live .editor-container,
    .main-live .preview-container {
      width: 50%;
      height: 100%;
    }

    /* Manual preview mode - full width, toggle visibility */
    .main-manual .editor-container {
      width: 100%;
      height: 100%;
    }

    .main-manual .preview-container {
      width: 100%;
      height: 100%;
      display: none;
    }

    .main-manual .preview-container.active {
      display: flex;
    }

    .main-manual .editor-container.hidden {
      display: none;
    }

    .editor-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Prevent wrapper scrolling */
      min-height: 0; /* Allow flex children to shrink */
    }

    textarea {
      width: 100%;
      height: 100%;
      padding: 20px;
      font-size: 1em;
      line-height: 1.6;
      border: none;
      resize: none;
      background: var(--editor-bg);
      color: var(--text-color);
      outline: none;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
      tab-size: 2;
      flex: 1;
      overflow-y: auto; /* Allow textarea to scroll vertically */
      overflow-x: auto; /* Allow textarea to scroll horizontally if needed */
    }

    /* Preview container with proper scrolling */
    .preview-toolbar {
      padding: 8px 15px;
      background: var(--header-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--divider-color);
      flex-shrink: 0; /* Prevent toolbar from shrinking */
    }
    .preview-actions {
      display: flex;
      gap: 8px;
    }
    .preview-actions button {
      padding: 4px 8px;
      font-size: 0.85em;
      background: var(--button-bg);
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .preview-actions button:hover {
      background: var(--button-hover);
    }

    #preview {
      padding: 20px;
      background: var(--preview-bg);
      flex: 1;
      overflow-y: auto; /* Allow preview to scroll vertically */
      overflow-x: auto; /* Allow preview to scroll horizontally if needed */
      min-height: 0; /* Allow flex child to shrink */
    }
    #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
      color: var(--accent-color);
      margin-top: 1.2em;
      margin-bottom: 0.6em;
    }
    #preview h1 { font-size: 2em; border-bottom: 1px solid var(--divider-color); padding-bottom: 0.3em; }
    #preview h2 { font-size: 1.7em; border-bottom: 1px solid var(--divider-color); padding-bottom: 0.3em; }
    #preview h3 { font-size: 1.4em; }
    #preview h4 { font-size: 1.2em; }
    #preview p { margin: 1em 0; line-height: 1.7; }
    #preview code {
      background: rgba(0, 0, 0, 0.1);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
    }
    #preview pre {
      background: rgba(0, 0, 0, 0.1);
      padding: 1em;
      border-radius: 4px;
      overflow: auto;
    }
    #preview pre code {
      background: transparent;
      padding: 0;
    }
    #preview blockquote {
      border-left: 4px solid var(--accent-color);
      margin: 1em 0;
      padding-left: 1em;
      color: var(--text-color);
      opacity: 0.8;
    }
    #preview table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }
    #preview table th, #preview table td {
      border: 1px solid var(--divider-color);
      padding: 0.5em 1em;
    }
    #preview table th {
      background: rgba(0, 0, 0, 0.1);
    }
    #preview img {
      max-width: 100%;
      border-radius: 4px;
    }
    #preview a {
      color: var(--accent-color);
      text-decoration: none;
    }
    #preview a:hover {
      text-decoration: underline;
    }
    #preview ul, #preview ol {
      padding-left: 2em;
      margin: 1em 0;
    }
    #preview li {
      margin: 0.5em 0;
      line-height: 1.6;
    }

    /* Math rendering styles */
    .katex {
      font-size: 1.1em;
    }
    .katex-display {
      margin: 1em 0;
    }

    .word-count {
      font-size: 0.85em;
      color: var(--text-color);
      opacity: 0.7;
    }
    .status-bar {
      display: flex;
      justify-content: space-between;
      padding: 5px 15px;
      background: var(--header-bg);
      font-size: 0.85em;
      color: var(--text-color);
      opacity: 0.7;
      border-top: 1px solid var(--divider-color);
      flex-shrink: 0; /* Prevent status bar from shrinking */
    }
    .theme-selector {
      position: relative;
      display: inline-block;
    }
    .theme-dropdown {
      display: none;
      position: absolute;
      right: 0;
      background-color: var(--button-bg);
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 4px;
      overflow: hidden;
    }
    .theme-dropdown button {
      color: var(--text-color);
      padding: 8px 16px;
      text-decoration: none;
      display: block;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
    }
    .theme-dropdown button:hover {
      background-color: var(--button-hover);
    }
    .theme-selector:hover .theme-dropdown {
      display: block;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .main-live {
        flex-direction: column;
      }
      .main-live .editor-container,
      .main-live .preview-container {
        width: 100%;
        height: 50%;
      }
      /* Hide header title text on mobile but keep icon */
      header h1 .header-text {
        display: none;
      }
      header h1 i {
        font-size: 1.3em;
        display: inline-block !important;
        visibility: visible !important;
        color: var(--text-color) !important;
      }
      header h1 {
        display: flex !important;
        align-items: center;
        gap: 0;
      }
      .rich-toolbar {
        padding: 5px 10px;
        gap: 3px;
      }
      .toolbar-group {
        padding-right: 5px;
        margin-right: 3px;
      }
      /* Rich toolbar buttons - hide text, keep icons */
      .toolbar-btn {
        padding: 4px 6px;
        min-width: 28px;
        height: 28px;
        font-size: 0; /* Hide text */
      }
      .toolbar-btn i {
        font-size: 14px; /* Show icons */
      }
      /* Header toolbar buttons - hide text, keep icons */
      .toolbar button {
        font-size: 0; /* Hide text */
      }
      .toolbar button i {
        font-size: 14px; /* Show icons */
      }
      /* Keep select dropdown text visible */
      .toolbar select {
        font-size: 0.8em;
      }
      textarea {
        padding: 15px;
        font-size: 0.9em;
      }
      #preview {
        padding: 15px;
      }

      .toolbar button, .toolbar select {
      padding: 6px 7px;
    }
    }

    /* Find and Replace Dialog Styles */
    .find-replace-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--header-bg);
      border: 1px solid var(--divider-color);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      min-width: 400px;
      display: none;
    }
    .find-replace-dialog.active {
      display: block;
    }
    .dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .dialog-title {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--text-color);
    }
    .dialog-close {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-size: 1.2em;
      padding: 5px;
      border-radius: 3px;
    }
    .dialog-close:hover {
      background: var(--button-hover);
    }
    .dialog-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }
    .dialog-label {
      min-width: 80px;
      color: var(--text-color);
      font-size: 0.9em;
    }
    .dialog-input {
      flex: 1;
      padding: 8px 12px;
      background: var(--editor-bg);
      color: var(--text-color);
      border: 1px solid var(--divider-color);
      border-radius: 4px;
      font-size: 0.9em;
    }
    .dialog-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }
    .dialog-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      justify-content: flex-end;
    }
    .dialog-btn {
      padding: 8px 16px;
      background: var(--button-bg);
      color: var(--text-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s ease;
    }
    .dialog-btn:hover {
      background: var(--button-hover);
    }
    .dialog-btn.primary {
      background: var(--accent-color);
      color: var(--bg-color);
    }
    .dialog-btn.primary:hover {
      opacity: 0.9;
    }
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }
    .dialog-overlay.active {
      display: block;
    }
    .find-options {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      font-size: 0.85em;
    }
    .find-option {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-color);
    }
    .find-option input[type="checkbox"] {
      accent-color: var(--accent-color);
    }

    /* Custom scrollbar styles */
    textarea::-webkit-scrollbar,
    #preview::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    textarea::-webkit-scrollbar-track,
    #preview::-webkit-scrollbar-track {
      background: var(--bg-color);
    }
    textarea::-webkit-scrollbar-thumb,
    #preview::-webkit-scrollbar-thumb {
      background: var(--divider-color);
      border-radius: 4px;
    }
    textarea::-webkit-scrollbar-thumb:hover,
    #preview::-webkit-scrollbar-thumb:hover {
      background: var(--button-hover);
    }

    /* Export styles for image generation */
    .export-container {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 40px;
      box-sizing: border-box;
    }
    
    .export-container h1, .export-container h2, .export-container h3, 
    .export-container h4, .export-container h5, .export-container h6 {
      margin-top: 1.2em;
      margin-bottom: 0.6em;
      font-weight: 600;
    }
    
    .export-container h1 { 
      font-size: 2em; 
      border-bottom: 2px solid currentColor; 
      padding-bottom: 0.3em; 
    }
    
    .export-container h2 { 
      font-size: 1.7em; 
      border-bottom: 1px solid currentColor; 
      padding-bottom: 0.3em; 
    }
    
    .export-container h3 { font-size: 1.4em; }
    .export-container h4 { font-size: 1.2em; }
    
    .export-container p { 
      margin: 1em 0; 
      line-height: 1.7; 
    }
    
    .export-container code {
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: "JetBrains Mono", "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.9em;
      background: rgba(128, 128, 128, 0.15);
    }
    
    .export-container pre {
      padding: 1em;
      overflow: auto;
      border-radius: 6px;
      line-height: 1.45;
      background: rgba(128, 128, 128, 0.1);
      border: 1px solid rgba(128, 128, 128, 0.2);
    }
    
    .export-container pre code {
      background: transparent;
      padding: 0;
    }
    
    .export-container blockquote {
      border-left: 4px solid currentColor;
      margin: 1em 0;
      padding: 0.5em 0 0.5em 1em;
      background: rgba(128, 128, 128, 0.05);
      border-radius: 0 4px 4px 0;
      opacity: 0.9;
    }
    
    .export-container table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.5em 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .export-container table th, 
    .export-container table td {
      border: 1px solid rgba(128, 128, 128, 0.3);
      padding: 0.75em 1em;
      text-align: left;
    }
    
    .export-container table th {
      font-weight: 600;
      background: rgba(128, 128, 128, 0.15);
    }
    
    .export-container table tr:nth-child(even) {
      background: rgba(128, 128, 128, 0.05);
    }
    
    .export-container img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .export-container a {
      text-decoration: none;
      transition: opacity 0.2s;
    }
    
    .export-container a:hover {
      text-decoration: underline;
      opacity: 0.8;
    }
    
    .export-container ul, .export-container ol {
      padding-left: 2em;
      margin: 1em 0;
    }
    
    .export-container li {
      margin: 0.5em 0;
      line-height: 1.6;
    }
    
    .export-container hr {
      border: 0;
      height: 2px;
      background: rgba(128, 128, 128, 0.3);
      margin: 2em 0;
      border-radius: 1px;
    }
    
    .export-container .katex {
      font-size: 1.1em;
    }
    
    .export-container .katex-display {
      margin: 1em 0;
    }

    /* Enhanced Prism.js styles for image export */
    .export-container pre[class*="language-"] {
      background: rgba(128, 128, 128, 0.1) !important;
      color: #ccc !important;
      border: 1px solid #444 !important;
      border-radius: 6px !important;
      padding: 1em !important;
      margin: 1em 0 !important;
      overflow: auto !important;
      font-family: "JetBrains Mono", "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace !important;
      font-size: 0.9em !important;
      line-height: 1.5 !important;
    }

    .export-container code[class*="language-"] {
      color: #ccc !important;
      background: none !important;
      font-family: "JetBrains Mono", "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace !important;
      font-size: 0.9em !important;
    }

    /* Prism Tomorrow Night theme colors for export */
    .export-container .token.comment,
    .export-container .token.prolog,
    .export-container .token.doctype,
    .export-container .token.cdata {
      color: #999 !important;
    }

    .export-container .token.punctuation {
      color: #ccc !important;
    }

    .export-container .token.property,
    .export-container .token.tag,
    .export-container .token.boolean,
    .export-container .token.number,
    .export-container .token.constant,
    .export-container .token.symbol,
    .export-container .token.deleted {
      color: #f2777a !important;
    }

    .export-container .token.selector,
    .export-container .token.attr-name,
    .export-container .token.string,
    .export-container .token.char,
    .export-container .token.builtin,
    .export-container .token.inserted {
      color: #99cc99 !important;
    }

    .export-container .token.operator,
    .export-container .token.entity,
    .export-container .token.url,
    .export-container .language-css .token.string,
    .export-container .style .token.string {
      color: #67cdcc !important;
    }

    .export-container .token.atrule,
    .export-container .token.attr-value,
    .export-container .token.keyword {
      color: #cc99cd !important;
    }

    .export-container .token.function,
    .export-container .token.class-name {
      color: #ffcc66 !important;
    }

    .export-container .token.regex,
    .export-container .token.important,
    .export-container .token.variable {
      color: #f99157 !important;
    }

    .export-container .token.important,
    .export-container .token.bold {
      font-weight: bold !important;
    }

    .export-container .token.italic {
      font-style: italic !important;
    }

    .export-container .token.entity {
      cursor: help !important;
    }

    /* Light theme syntax highlighting for export */
    .export-container.light-theme pre[class*="language-"] {
      background: #f5f5f5 !important;
      color: #333 !important;
      border: 1px solid #ddd !important;
    }

    .export-container.light-theme code[class*="language-"] {
      color: #333 !important;
    }

    .export-container.light-theme .token.comment,
    .export-container.light-theme .token.prolog,
    .export-container.light-theme .token.doctype,
    .export-container.light-theme .token.cdata {
      color: #708090 !important;
    }

    .export-container.light-theme .token.property,
    .export-container.light-theme .token.tag,
    .export-container.light-theme .token.boolean,
    .export-container.light-theme .token.number,
    .export-container.light-theme .token.constant,
    .export-container.light-theme .token.symbol,
    .export-container.light-theme .token.deleted {
      color: #d73a49 !important;
    }

    .export-container.light-theme .token.selector,
    .export-container.light-theme .token.attr-name,
    .export-container.light-theme .token.string,
    .export-container.light-theme .token.char,
    .export-container.light-theme .token.builtin,
    .export-container.light-theme .token.inserted {
      color: #22863a !important;
    }

    .export-container.light-theme .token.operator,
    .export-container.light-theme .token.entity,
    .export-container.light-theme .token.url,
    .export-container.light-theme .language-css .token.string,
    .export-container.light-theme .style .token.string {
      color: #005cc5 !important;
    }

    .export-container.light-theme .token.atrule,
    .export-container.light-theme .token.attr-value,
    .export-container.light-theme .token.keyword {
      color: #d73a49 !important;
    }

    .export-container.light-theme .token.function,
    .export-container.light-theme .token.class-name {
      color: #6f42c1 !important;
    }

    .export-container.light-theme .token.regex,
    .export-container.light-theme .token.important,
    .export-container.light-theme .token.variable {
      color: #e36209 !important;
    }
  </style>
</head>
<body class="theme-dark">

<header>
  <h1><i class="fa-brands fa-markdown"></i><span class="header-text">Markdown Editor</span></h1> &nbsp;
  <div class="toolbar">
    <div class="theme-selector">
      <button id="theme-btn"><i class="fas fa-palette"></i> Theme</button>
      <div class="theme-dropdown">
        <button onclick="changeTheme('light')">Light</button>
        <button onclick="changeTheme('dark')">Dark</button>
        <button onclick="changeTheme('blue')">Blue</button>
        <button onclick="changeTheme('dark-blue')">Dark Blue</button>
        <button onclick="changeTheme('deep-purple')">Deep Purple</button>
        <button onclick="changeTheme('solarized')">Solarized</button>
      </div>
    </div>
    <select id="mode-select">
      <option value="live">Live Preview</option>
      <option value="manual">Manual Preview</option>
    </select>
    <button id="toggle-view-btn" style="display: none;"><i class="fas fa-eye"></i> Preview</button>
    <button onclick="saveFile()"><i class="fa-solid fa-floppy-disk"></i> Save</button>
    <button onclick="exportHTML()"><i class="fas fa-file-code"></i> HTML</button>
    <button onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
    <button onclick="exportImage()"><i class="fas fa-file-image"></i> Image</button>
  </div>
</header>

<main id="main" class="main-live">
  <div class="editor-container" id="editor-container">
    <div class="rich-toolbar">
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="openFile()" title="Open File"><i class="fas fa-folder-open"></i></button>
        <input type="file" id="file-input" accept=".md,.txt" style="display: none;" onchange="handleFileLoad(event)">
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertText('# ', '')" title="Heading 1"><i class="fas fa-heading"></i>1</button>
        <button class="toolbar-btn" onclick="insertText('## ', '')" title="Heading 2"><i class="fas fa-heading"></i>2</button>
        <button class="toolbar-btn" onclick="insertText('### ', '')" title="Heading 3"><i class="fas fa-heading"></i>3</button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="wrapText('**', '**')" title="Bold"><i class="fas fa-bold"></i></button>
        <button class="toolbar-btn" onclick="wrapText('*', '*')" title="Italic"><i class="fas fa-italic"></i></button>
        <button class="toolbar-btn" onclick="wrapText('<u>', '</u>')" title="Underline"><i class="fas fa-underline"></i></button>
        <button class="toolbar-btn" onclick="wrapText('~~', '~~')" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
        <button class="toolbar-btn" onclick="wrapText('<sup>', '</sup>')" title="Superscript"><i class="fas fa-superscript"></i></button>
        <button class="toolbar-btn" onclick="wrapText('<sub>', '</sub>')" title="Subscript"><i class="fas fa-subscript"></i></button>
        <button class="toolbar-btn" onclick="wrapText('`', '`')" title="Inline Code"><i class="fas fa-code"></i></button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertText('- ', '')" title="Unordered List"><i class="fas fa-list-ul"></i></button>
        <button class="toolbar-btn" onclick="insertText('1. ', '')" title="Ordered List"><i class="fas fa-list-ol"></i></button>
        <button class="toolbar-btn" onclick="insertText('- [ ] ', '')" title="Task List"><i class="fas fa-tasks"></i></button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertText('> ', '')" title="Quote"><i class="fas fa-quote-left"></i></button>
        <button class="toolbar-btn" onclick="insertText('```\n', '\n```')" title="Code Block"><i class="fas fa-code"></i></button>
        <button class="toolbar-btn" onclick="insertText('---\n', '')" title="Horizontal Rule"><i class="fas fa-minus"></i></button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="insertText('[', '](url)')" title="Link"><i class="fas fa-link"></i></button>
        <button class="toolbar-btn" onclick="insertText('![alt](', ')')" title="Image"><i class="fas fa-image"></i></button>
        <button class="toolbar-btn" onclick="insertTable()" title="Table"><i class="fas fa-table"></i></button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="wrapText('$', '$')" title="Inline Math"><i class="fas fa-square-root-alt"></i></button>
        <button class="toolbar-btn" onclick="wrapText('$$\n', '\n$$')" title="Display Math"><i class="fas fa-calculator"></i></button>
      </div>
      <div class="toolbar-group">
        <button class="toolbar-btn" onclick="findText()" title="Find"><i class="fas fa-search"></i></button>
        <button class="toolbar-btn" onclick="selectAllText()" title="Select All"><i class="fas fa-check-square"></i></button>
        <button class="toolbar-btn" onclick="undoAction()" title="Undo"><i class="fas fa-undo"></i></button>
        <button class="toolbar-btn" onclick="redoAction()" title="Redo"><i class="fas fa-redo"></i></button>
      </div>
    </div>
    <div class="editor-wrapper">
      <textarea id="editor" placeholder="# Welcome to Rich Markdown Editor!

Start writing your markdown here with advanced features."></textarea>
    </div>
    <div class="status-bar">
      <span class="word-count">Words: 0 | Characters: 0</span>
      <span id="syntax-help"><i class="fas fa-question-circle"></i> Markdown Help</span>
    </div>
  </div>
  <div class="preview-container" id="preview-container">
    <div class="preview-toolbar">
      <span><i class="fas fa-search"></i> Preview</span>
      <div class="preview-actions">
        <button onclick="refreshPreview()"><i class="fas fa-sync-alt"></i></button>
        <button onclick="toggleFullscreen()"><i class="fas fa-expand"></i></button>
      </div>
    </div>
    <div id="preview"></div>
  </div>
</main>

<!-- Find and Replace Dialog -->
<div class="dialog-overlay" id="dialog-overlay" onclick="closeFindReplaceDialog()"></div>
<div class="find-replace-dialog" id="find-replace-dialog">
  <div class="dialog-header">
    <span class="dialog-title">Find and Replace</span>
    <button class="dialog-close" onclick="closeFindReplaceDialog()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="dialog-row">
    <label class="dialog-label">Find:</label>
    <input type="text" class="dialog-input" id="find-input" placeholder="Enter text to find">
  </div>
  
  <div class="dialog-row">
    <label class="dialog-label">Replace:</label>
    <input type="text" class="dialog-input" id="replace-input" placeholder="Enter replacement text">
  </div>
  
  <div class="find-options">
    <label class="find-option">
      <input type="checkbox" id="case-sensitive">
      Case sensitive
    </label>
    <label class="find-option">
      <input type="checkbox" id="whole-word">
      Whole word
    </label>
  </div>
  
  <div class="dialog-actions">
    <button class="dialog-btn" onclick="findNext()">Find Next</button>
    <button class="dialog-btn" onclick="findPrevious()">Find Previous</button>
    <button class="dialog-btn" onclick="replaceOne()">Replace</button>
    <button class="dialog-btn primary" onclick="replaceAll()">Replace All</button>
    <button class="dialog-btn" onclick="closeFindReplaceDialog()">Close</button>
  </div>
</div>

<script>

  const editor = document.getElementById('editor');
  const preview = document.getElementById('preview');
  const modeSelect = document.getElementById('mode-select');
  const toggleViewBtn = document.getElementById('toggle-view-btn');
  const editorContainer = document.getElementById('editor-container');
  const previewContainer = document.getElementById('preview-container');
  const main = document.getElementById('main');
  const wordCountEl = document.querySelector('.word-count');
  const syntaxHelp = document.getElementById('syntax-help');

  let isLivePreview = true;
  let isPreviewVisible = false;
  let undoStack = [];
  let redoStack = [];
  let currentContent = '';

  // Configure marked for better markdown parsing
  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (lang && Prism.languages[lang]) {
        return Prism.highlight(code, Prism.languages[lang], lang);
      }
      return code;
    }
  });

  // Initialize
  function init() {
    updateWordCount();
    
    // Check if mobile device and set default to Manual Preview
    if (window.innerWidth <= 768) {
      modeSelect.value = 'manual';
      isLivePreview = false;
    }
    
    modeSelect.addEventListener('change', togglePreviewMode);
    toggleViewBtn.addEventListener('click', toggleView);
    editor.addEventListener('input', handleEditorInput);
    editor.addEventListener('keydown', handleKeyDown);
    syntaxHelp.addEventListener('click', showSyntaxHelp);
    document.addEventListener('keydown', handleGlobalKeyDown);
    
    // Initialize content and undo stack
    currentContent = editor.value;
    saveToUndoStack();
    
    // Set initial preview mode
    togglePreviewMode();
  }

  function handleEditorInput() {
    updateWordCount();
    if (isLivePreview) {
      updatePreview();
    }
    
    // Save to undo stack if content changed significantly
    if (Math.abs(editor.value.length - currentContent.length) > 10 || 
        editor.value !== currentContent) {
      saveToUndoStack();
      currentContent = editor.value;
    }
  }

  function saveToUndoStack() {
    undoStack.push({
      content: editor.value,
      selectionStart: editor.selectionStart,
      selectionEnd: editor.selectionEnd
    });
    if (undoStack.length > 50) {
      undoStack.shift();
    }
    redoStack = [];
  }

  function updatePreview() {
    let content = editor.value;
    
    // Process math expressions before markdown
    content = content.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
      try {
        return katex.renderToString(math, { displayMode: true });
      } catch (e) {
        return `<span style="color: red;">Math Error: ${e.message}</span>`;
      }
    });
    
    content = content.replace(/\$([^$\n]+?)\$/g, (match, math) => {
      try {
        return katex.renderToString(math, { displayMode: false });
      } catch (e) {
        return `<span style="color: red;">Math Error: ${e.message}</span>`;
      }
    });
    
    // Parse markdown
    preview.innerHTML = marked.parse(content);
    
    // Apply syntax highlighting to code blocks
    Prism.highlightAllUnder(preview);
  }

  function togglePreviewMode() {
    isLivePreview = modeSelect.value === 'live';
    
    if (isLivePreview) {
      // Live Preview: Show both editor and preview side by side
      main.className = 'main-live';
      toggleViewBtn.style.display = 'none';
      editorContainer.classList.remove('hidden');
      previewContainer.classList.remove('active');
      updatePreview();
    } else {
      // Manual Preview: Show only editor (full width)
      main.className = 'main-manual';
      toggleViewBtn.style.display = 'block';
      editorContainer.classList.remove('hidden');
      previewContainer.classList.remove('active');
      isPreviewVisible = false;
      toggleViewBtn.innerHTML = '<i class="fas fa-eye"></i> Preview';
    }
  }

  function toggleView() {
    if (isLivePreview) return;
    
    isPreviewVisible = !isPreviewVisible;
    
    if (isPreviewVisible) {
      // Show Preview ONLY (full screen)
      editorContainer.classList.add('hidden');
      previewContainer.classList.add('active');
      toggleViewBtn.innerHTML = '<i class="fas fa-edit"></i> Editor';
      updatePreview();
    } else {
      // Show Editor ONLY (full screen)
      editorContainer.classList.remove('hidden');
      previewContainer.classList.remove('active');
      toggleViewBtn.innerHTML = '<i class="fas fa-eye"></i> Preview';
    }
  }

  function refreshPreview() {
    updatePreview();
  }

  function updateWordCount() {
    const text = editor.value;
    const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
    const charCount = text.length;
    wordCountEl.textContent = `Words: ${wordCount} | Characters: ${charCount}`;
  }

  // Rich toolbar functions
  function insertText(before, after) {
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const text = editor.value;
    const selectedText = text.substring(start, end);
    
    const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
    editor.value = newText;
    
    // Set cursor position
    const newCursorPos = start + before.length + selectedText.length + after.length;
    editor.setSelectionRange(newCursorPos, newCursorPos);
    editor.focus();
    
    handleEditorInput();
  }

  function wrapText(before, after) {
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const text = editor.value;
    const selectedText = text.substring(start, end);
    
    if (selectedText) {
      const newText = text.substring(0, start) + before + selectedText + after + text.substring(end);
      editor.value = newText;
      editor.setSelectionRange(start + before.length, start + before.length + selectedText.length);
    } else {
      const newText = text.substring(0, start) + before + after + text.substring(end);
      editor.value = newText;
      editor.setSelectionRange(start + before.length, start + before.length);
    }
    
    editor.focus();
    handleEditorInput();
  }

  function insertTable() {
    const tableText = `| Column 1 | Column 2 | Column 3 |
|----------|----------|----------|
| Cell 1   | Cell 2   | Cell 3   |
| Cell 4   | Cell 5   | Cell 6   |

`;
    insertText(tableText, '');
  }

  function undoAction() {
    if (undoStack.length > 1) {
      const current = undoStack.pop();
      redoStack.push(current);
      const previous = undoStack[undoStack.length - 1];
      editor.value = previous.content;
      editor.setSelectionRange(previous.selectionStart, previous.selectionEnd);
      currentContent = editor.value;
      handleEditorInput();
    }
  }

  function redoAction() {
    if (redoStack.length > 0) {
      const next = redoStack.pop();
      undoStack.push(next);
      editor.value = next.content;
      editor.setSelectionRange(next.selectionStart, next.selectionEnd);
      currentContent = editor.value;
      handleEditorInput();
    }
  }

  function handleKeyDown(e) {
    // Tab handling
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      
      if (e.shiftKey) {
        // Shift+Tab: Remove indentation
        const lines = editor.value.split('\n');
        const startLine = editor.value.substring(0, start).split('\n').length - 1;
        const endLine = editor.value.substring(0, end).split('\n').length - 1;
        
        for (let i = startLine; i <= endLine; i++) {
          if (lines[i].startsWith('  ')) {
            lines[i] = lines[i].substring(2);
          } else if (lines[i].startsWith('\t')) {
            lines[i] = lines[i].substring(1);
          }
        }
        
        editor.value = lines.join('\n');
      } else {
        // Tab: Add indentation
        editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
        editor.setSelectionRange(start + 2, start + 2);
      }
      
      handleEditorInput();
    }
  }

  function handleGlobalKeyDown(e) {
    // Global shortcuts
    if (e.ctrlKey || e.metaKey) {
      switch (e.key) {
        case 's':
          e.preventDefault();
          saveFile();
          break;
        case 'o':
          e.preventDefault();
          openFile();
          break;
        case 'f':
          if (document.activeElement === editor) {
            e.preventDefault();
            findText();
          }
          break;
        case 'a':
          if (document.activeElement === editor) {
            e.preventDefault();
            selectAllText();
          }
          break;
        case 'z':
          if (!e.shiftKey) {
            e.preventDefault();
            undoAction();
          }
          break;
        case 'y':
        case 'Z':
          if (e.shiftKey) {
            e.preventDefault();
            redoAction();
          }
          break;
        case 'b':
          if (document.activeElement === editor) {
            e.preventDefault();
            wrapText('**', '**');
          }
          break;
        case 'i':
          if (document.activeElement === editor) {
            e.preventDefault();
            wrapText('*', '*');
          }
          break;
        case 'u':
          if (document.activeElement === editor) {
            e.preventDefault();
            wrapText('<u>', '</u>');
          }
          break;
      }
    }
  }

function showSyntaxHelp() {
  const url = "https://raw.githubusercontent.com/mish0as/md-editor/refs/heads/main/help.text";

  fetch(url)
    .then(response => {
      if (!response.ok) {
        throw new Error("Failed to load help file.");
      }
      return response.text();
    })
    .then(helpText => {
      if (editor.value.trim() === '') {
        editor.value = helpText;
      } else {
        editor.value = helpText + '\n\n' + editor.value;
      }
      editor.focus();
      updatePreview();
      updateWordCount();
    })
    .catch(error => {
      alert("Error loading help text: " + error.message);
    });
}


  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      previewContainer.requestFullscreen().catch(err => {
        alert(`Error attempting to enable fullscreen: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  }

  function changeTheme(themeName) {
    document.body.className = 'theme-' + themeName;
    // Update preview to reflect new theme colors
    if (isLivePreview || isPreviewVisible) {
      updatePreview();
    }
  }

  // New toolbar functions
  function saveFile() {
    const content = editor.value;
    const blob = new Blob([content], { type: 'text/markdown' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'document.md';
    link.click();
  }

  function openFile() {
    document.getElementById('file-input').click();
  }

  function handleFileLoad(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        editor.value = e.target.result;
        updateWordCount();
        if (isLivePreview) {
          updatePreview();
        }
        saveToUndoStack();
        currentContent = editor.value;
      };
      reader.readAsText(file);
    }
  }

  // Find and Replace functionality
  let currentSearchIndex = -1;
  let searchMatches = [];
  let lastSearchTerm = '';

  function findText() {
    openFindReplaceDialog();
  }

  function openFindReplaceDialog() {
    document.getElementById('dialog-overlay').classList.add('active');
    document.getElementById('find-replace-dialog').classList.add('active');
    document.getElementById('find-input').focus();
    
    // If there's selected text, use it as the search term
    const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
    if (selectedText) {
      document.getElementById('find-input').value = selectedText;
    }
  }

  function closeFindReplaceDialog() {
    document.getElementById('dialog-overlay').classList.remove('active');
    document.getElementById('find-replace-dialog').classList.remove('active');
    editor.focus();
    clearHighlights();
  }

  function buildSearchRegex(searchTerm) {
    const caseSensitive = document.getElementById('case-sensitive').checked;
    const wholeWord = document.getElementById('whole-word').checked;
    
    let pattern = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Escape special characters
    
    if (wholeWord) {
      pattern = '\\b' + pattern + '\\b';
    }
    
    const flags = caseSensitive ? 'g' : 'gi';
    return new RegExp(pattern, flags);
  }

  function findMatches(searchTerm) {
    if (!searchTerm) return [];
    
    const regex = buildSearchRegex(searchTerm);
    const content = editor.value;
    const matches = [];
    let match;
    
    while ((match = regex.exec(content)) !== null) {
      matches.push({
        index: match.index,
        length: match[0].length,
        text: match[0]
      });
      
      // Prevent infinite loop on zero-length matches
      if (match.index === regex.lastIndex) {
        regex.lastIndex++;
      }
    }
    
    return matches;
  }

  function highlightMatch(matchIndex) {
    if (matchIndex >= 0 && matchIndex < searchMatches.length) {
      const match = searchMatches[matchIndex];
      editor.focus();
      editor.setSelectionRange(match.index, match.index + match.length);
      
      // Scroll to the match
      const lineHeight = parseInt(getComputedStyle(editor).lineHeight);
      const lines = editor.value.substring(0, match.index).split('\n').length;
      editor.scrollTop = Math.max(0, (lines - 5) * lineHeight);
    }
  }

  function clearHighlights() {
    // Clear any existing highlights
    searchMatches = [];
    currentSearchIndex = -1;
  }

  function findNext() {
    const searchTerm = document.getElementById('find-input').value;
    if (!searchTerm) return;
    
    if (searchTerm !== lastSearchTerm) {
      searchMatches = findMatches(searchTerm);
      lastSearchTerm = searchTerm;
      currentSearchIndex = -1;
    }
    
    if (searchMatches.length === 0) {
      alert('Text not found');
      return;
    }
    
    currentSearchIndex = (currentSearchIndex + 1) % searchMatches.length;
    highlightMatch(currentSearchIndex);
  }

  function findPrevious() {
    const searchTerm = document.getElementById('find-input').value;
    if (!searchTerm) return;
    
    if (searchTerm !== lastSearchTerm) {
      searchMatches = findMatches(searchTerm);
      lastSearchTerm = searchTerm;
      currentSearchIndex = searchMatches.length;
    }
    
    if (searchMatches.length === 0) {
      alert('Text not found');
      return;
    }
    
    currentSearchIndex = currentSearchIndex <= 0 ? searchMatches.length - 1 : currentSearchIndex - 1;
    highlightMatch(currentSearchIndex);
  }

  function replaceOne() {
    const searchTerm = document.getElementById('find-input').value;
    const replaceTerm = document.getElementById('replace-input').value;
    
    if (!searchTerm) return;
    
    if (searchMatches.length === 0) {
      findNext();
      return;
    }
    
    if (currentSearchIndex >= 0 && currentSearchIndex < searchMatches.length) {
      const match = searchMatches[currentSearchIndex];
      const content = editor.value;
      
      // Replace the current match
      const newContent = content.substring(0, match.index) + 
                        replaceTerm + 
                        content.substring(match.index + match.length);
      
      editor.value = newContent;
      
      // Update cursor position
      editor.setSelectionRange(match.index + replaceTerm.length, match.index + replaceTerm.length);
      
      // Refresh matches after replacement
      const lengthDiff = replaceTerm.length - match.length;
      searchMatches = findMatches(searchTerm);
      
      // Adjust current index
      if (currentSearchIndex < searchMatches.length) {
        highlightMatch(currentSearchIndex);
      } else if (searchMatches.length > 0) {
        currentSearchIndex = 0;
        highlightMatch(currentSearchIndex);
      }
      
      handleEditorInput();
    }
  }

  function replaceAll() {
    const searchTerm = document.getElementById('find-input').value;
    const replaceTerm = document.getElementById('replace-input').value;
    
    if (!searchTerm) return;
    
    const regex = buildSearchRegex(searchTerm);
    const content = editor.value;
    const newContent = content.replace(regex, replaceTerm);
    
    if (newContent !== content) {
      const replacementCount = (content.match(regex) || []).length;
      editor.value = newContent;
      editor.focus();
      handleEditorInput();
      alert(`Replaced ${replacementCount} occurrence(s)`);
      
      // Clear search state
      searchMatches = [];
      currentSearchIndex = -1;
      lastSearchTerm = '';
    } else {
      alert('Text not found');
    }
  }

  // Add keyboard support for the dialog
  document.addEventListener('keydown', function(e) {
    const dialog = document.getElementById('find-replace-dialog');
    if (dialog.classList.contains('active')) {
      if (e.key === 'Escape') {
        closeFindReplaceDialog();
      } else if (e.key === 'Enter') {
        if (e.shiftKey) {
          findPrevious();
        } else {
          findNext();
        }
      } else if (e.key === 'F3') {
        e.preventDefault();
        if (e.shiftKey) {
          findPrevious();
        } else {
          findNext();
        }
      }
    }
  });

  function selectAllText() {
    editor.focus();
    editor.select();
  }

function exportHTML() {
    // Create a temporary preview with math rendered
    const tempDiv = document.createElement('div');
    let content = editor.value;
    
    // Process math expressions
    content = content.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
      try {
        return katex.renderToString(math, { displayMode: true });
      } catch (e) {
        return `<span style="color: red;">Math Error: ${e.message}</span>`;
      }
    });
    
    content = content.replace(/\$([^$\n]+?)\$/g, (match, math) => {
      try {
        return katex.renderToString(math, { displayMode: false });
      } catch (e) {
        return `<span style="color: red;">Math Error: ${e.message}</span>`;
      }
    });
    
    tempDiv.innerHTML = marked.parse(content);
    
    // Apply syntax highlighting to code blocks
    Prism.highlightAllUnder(tempDiv);

    const htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Export</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #ffffff;
    }
    h1, h2, h3, h4, h5, h6 {
      color: #2c3e50;
      margin-top: 1.2em;
      margin-bottom: 0.6em;
    }
    h1 { font-size: 2em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
    h2 { font-size: 1.7em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
    h3 { font-size: 1.4em; }
    h4 { font-size: 1.2em; }
    p { margin: 1em 0; line-height: 1.7; }
    code {
      background: #f5f5f5;
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: "JetBrains Mono", "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.9em;
      color: #d63384;
    }
    pre {
      background: #f5f5f5;
      padding: 1em;
      overflow: auto;
      border-radius: 4px;
      line-height: 1.45;
      margin: 1em 0;
      border: 1px solid #e1e1e1;
    }
    pre code {
      background: transparent;
      padding: 0;
      color: #333;
    }
    blockquote {
      border-left: 4px solid #3498db;
      margin: 1em 0;
      padding-left: 1em;
      color: #555;
      background: #f9f9f9;
      padding: 10px 15px;
      border-radius: 0 4px 4px 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.5em 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 0.75em 1em;
      text-align: left;
    }
    table th {
      background: #f5f5f5;
      font-weight: 600;
    }
    table tr:nth-child(even) {
      background: #f9f9f9;
    }
    table tr:hover {
      background: #f1f1f1;
    }
    img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }
    a {
      color: #3498db;
      text-decoration: none;
      transition: color 0.2s;
    }
    a:hover {
      color: #1d6fa5;
      text-decoration: underline;
    }
    ul, ol {
      padding-left: 2em;
      margin: 1em 0;
    }
    li {
      margin: 0.5em 0;
      line-height: 1.6;
    }
    hr {
      border: 0;
      height: 1px;
      background: #eee;
      margin: 2em 0;
    }
    .katex {
      font-size: 1.1em;
    }
    .katex-display {
      margin: 1em 0;
    }

    /* Prism Light Theme Colors */
    .token.comment,
    .token.prolog,
    .token.doctype,
    .token.cdata {
      color: #708090;
    }

    .token.punctuation {
      color: #999;
    }

    .token.property,
    .token.tag,
    .token.boolean,
    .token.number,
    .token.constant,
    .token.symbol,
    .token.deleted {
      color: #d63384;
    }

    .token.selector,
    .token.attr-name,
    .token.string,
    .token.char,
    .token.builtin,
    .token.inserted {
      color: #22863a;
    }

    .token.operator,
    .token.entity,
    .token.url,
    .language-css .token.string,
    .style .token.string {
      color: #005cc5;
    }

    .token.atrule,
    .token.attr-value,
    .token.keyword {
      color: #d63384;
    }

    .token.function,
    .token.class-name {
      color: #6f42c1;
    }

    .token.regex,
    .token.important,
    .token.variable {
      color: #e36209;
    }

    .token.important,
    .token.bold {
      font-weight: bold;
    }

    .token.italic {
      font-style: italic;
    }

    .token.entity {
      cursor: help;
    }
  </style>
</head>
<body>
${tempDiv.innerHTML}
</body>
</html>`;
    
    const blob = new Blob([htmlContent], {type: 'text/html'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'markdown_export.html';
    link.click();
}

  function exportPDF() {
    // Create a temporary preview with math rendered
    const tempDiv = document.createElement('div');
    let content = editor.value;
    
    // Process math expressions
    content = content.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
      try {
        return katex.renderToString(math, { displayMode: true });
      } catch (e) {
        return `<span style="color: red;">Math Error: ${e.message}</span>`;
      }
    });
    
    content = content.replace(/\$([^$\n]+?)\$/g, (match, math) => {
      try {
        return katex.renderToString(math, { displayMode: false });
      } catch (e) {
        return `<span style="color: red;">Math Error: ${e.message}</span>`;
      }
    });
    
    tempDiv.innerHTML = marked.parse(content);

    // Style for PDF appearance (light mode)
    tempDiv.style.background = '#ffffff';
    tempDiv.style.color = '#111111';
    tempDiv.style.padding = '30px';
    tempDiv.style.fontFamily = 'Georgia, serif';
    tempDiv.style.fontSize = '12pt';
    tempDiv.style.lineHeight = '1.6';
    tempDiv.style.maxWidth = '800px';
    tempDiv.style.margin = 'auto';

    // Wrap in container
    const container = document.createElement('div');
    container.style.position = 'absolute';
    container.style.left = '-9999px';
    container.style.top = '0';
    container.style.width = '1000px';
    container.style.background = '#ffffff';
    container.appendChild(tempDiv);
    document.body.appendChild(container);

    // Options for html2pdf
    const opt = {
      margin:       [0.5, 0.5, 0.5, 0.5], // inches
      filename:     'markdown_export.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2 },
      jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' },
      pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
    };

    html2pdf().set(opt).from(tempDiv).save().then(() => {
      document.body.removeChild(container);
    });
  }

  // Get current theme colors
  function getCurrentThemeColors() {
    const computedStyle = getComputedStyle(document.body);
    return {
      bgColor: computedStyle.getPropertyValue('--preview-bg').trim(),
      textColor: computedStyle.getPropertyValue('--text-color').trim(),
      accentColor: computedStyle.getPropertyValue('--accent-color').trim(),
      dividerColor: computedStyle.getPropertyValue('--divider-color').trim()
    };
  }

  // Check if current theme is light
  function isLightTheme() {
    return document.body.classList.contains('theme-light');
  }

  function exportImage() {
    // Create a temporary preview with math rendered and proper styling
    const tempDiv = document.createElement('div');
    let content = editor.value;
    
    // Process math expressions
    content = content.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
      try {
        return katex.renderToString(math, { displayMode: true });
      } catch (e) {
        return `<span style="color: red;">Math Error: ${e.message}</span>`;
      }
    });
    
    content = content.replace(/\$([^$\n]+?)\$/g, (match, math) => {
      try {
        return katex.renderToString(math, { displayMode: false });
      } catch (e) {
        return `<span style="color: red;">Math Error: ${e.message}</span>`;
      }
    });
    
    tempDiv.innerHTML = marked.parse(content);
    
    // Apply syntax highlighting to code blocks BEFORE styling
    Prism.highlightAllUnder(tempDiv);
    
    // Add the export-container class for proper styling
    tempDiv.className = 'export-container';
    
    // Add light theme class if current theme is light
    if (isLightTheme()) {
      tempDiv.classList.add('light-theme');
    }
    
    // Get current theme colors
    const themeColors = getCurrentThemeColors();
    
    // Apply theme-aware styling
    tempDiv.style.cssText = `
      position: absolute;
      top: 0;
      left: -9999px;
      width: 900px;
      background: ${themeColors.bgColor};
      color: ${themeColors.textColor};
      padding: 40px;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      overflow: visible;
      z-index: -1;
    `;
    
    // Apply accent color to headings and links
    const headings = tempDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
    headings.forEach(heading => {
      heading.style.color = themeColors.accentColor;
    });
    
    const links = tempDiv.querySelectorAll('a');
    links.forEach(link => {
      link.style.color = themeColors.accentColor;
    });
    
    // Apply proper table styling
    const tables = tempDiv.querySelectorAll('table');
    tables.forEach(table => {
      table.style.cssText = `
        border-collapse: collapse;
        width: 100%;
        margin: 1.5em 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 6px;
        overflow: hidden;
      `;
      
      const cells = table.querySelectorAll('th, td');
      cells.forEach(cell => {
        cell.style.cssText = `
          border: 1px solid ${themeColors.dividerColor};
          padding: 0.75em 1em;
          text-align: left;
        `;
      });
      
      const headers = table.querySelectorAll('th');
      headers.forEach(header => {
        header.style.cssText += `
          font-weight: 600;
          background: rgba(128, 128, 128, 0.15);
        `;
      });
      
      const rows = table.querySelectorAll('tr:nth-child(even)');
      rows.forEach(row => {
        row.style.background = 'rgba(128, 128, 128, 0.05)';
      });
    });
    
    // Apply proper blockquote styling
    const blockquotes = tempDiv.querySelectorAll('blockquote');
    blockquotes.forEach(blockquote => {
      blockquote.style.cssText = `
        border-left: 4px solid ${themeColors.accentColor};
        margin: 1em 0;
        padding: 0.5em 0 0.5em 1em;
        background: rgba(128, 128, 128, 0.05);
        border-radius: 0 4px 4px 0;
        opacity: 0.9;
      `;
    });
    
    // Apply proper inline code styling (not in pre blocks)
    const inlineCodes = tempDiv.querySelectorAll('code:not(pre code)');
    inlineCodes.forEach(code => {
      code.style.cssText = `
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: "JetBrains Mono", "Fira Code", "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 0.9em;
        background: rgba(128, 128, 128, 0.15);
      `;
    });

    // Add to DOM temporarily
    document.body.appendChild(tempDiv);
    
    // Wait for fonts and styles to load, then capture
    requestAnimationFrame(() => {
      setTimeout(() => {
        html2canvas(tempDiv, {
          scale: 3,
          useCORS: true,
          allowTaint: true,
          backgroundColor: themeColors.bgColor,
          windowWidth: tempDiv.scrollWidth,
          windowHeight: tempDiv.scrollHeight,
          width: tempDiv.scrollWidth,
          height: tempDiv.scrollHeight,
          scrollX: 0,
          scrollY: 0
        }).then(canvas => {
          const link = document.createElement('a');
          link.href = canvas.toDataURL('image/png', 1.0);
          link.download = 'markdown_export.png';
          link.click();
          document.body.removeChild(tempDiv);
        }).catch(error => {
          console.error('Error generating image:', error);
          document.body.removeChild(tempDiv);
          alert('Error generating image. Please try again.');
        });
      }, 200); // Increased timeout to ensure Prism highlighting is applied
    });
  }

  // Initialize the app
  window.onload = init;
</script>

</body>
</html>
